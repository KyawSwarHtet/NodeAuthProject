"use strict";var jwt=require("jsonwebtoken"),fs=require("fs"),asyncHandler=require("express-async-handler"),mainPath=require("./baseFilepath"),User=require("../model/userModel"),bcrypt=require("bcryptjs"),path=require("path"),getAllUser=function(e,r){r.render("user/register",{pageTitle:"Register",path:"/register"})},registerUser=asyncHandler(function(r,t){var s,n,a,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=r.body,n=s.username,a=s.email,i=s.password,n=n.trim(),a=a.trim(),i=i.trim(),n&&a&&i){e.next=8;break}t.status(400).json({status:"FAILED",message:"Empty input Fields!"}),e.next=22;break;case 8:if(/^[a-zA-Z ]*$/.test(n)){e.next=12;break}t.status(400).json({status:"FAILED",message:"Invalid name entered"}),e.next=22;break;case 12:if(/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/.test(a)){e.next=16;break}t.status(400).json({status:"FAILED",message:"Invalid email entered"}),e.next=22;break;case 16:if(!(i.length<8)){e.next=20;break}t.status(400).json({status:"FAILED",message:"Password is too short!"}),e.next=22;break;case 20:return e.next=22,regeneratorRuntime.awrap(User.find({email:a}).then(function(e){if(e.length)t.status(400).json({status:"FAILED",message:"User with the provided email already exists"});else{bcrypt.hash(i,10).then(function(e){new User({username:n,email:a,password:e}).save().then(function(e){console.log("user  post is success"),t.redirect("/register")}).catch(function(e){t.status(400).json({status:"FAILED",message:"An error occurred while saving user account!"})})}).catch(function(e){t.status(400).json({status:"FAILED",message:"An error occurred while hashing password!"})})}}).catch(function(e){t.status(400).json({status:"FAILED",message:"An error occured while checking for existing user!"})}));case 22:case"end":return e.stop()}})}),loginUser=asyncHandler(function(r,t){var s,n,a,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=r.body,n=s.email,a=s.password,n=n.trim(),a=a.trim(),""!=n&&""!=a){e.next=7;break}t.status(400).json({status:"FAILED",message:"Empty credentials supplied"}),e.next=20;break;case 7:return e.next=9,regeneratorRuntime.awrap(User.findOne({email:n}));case 9:if(i=e.sent,e.t0=i,e.t0)return e.next=14,regeneratorRuntime.awrap(bcrypt.compare(a,i.password));e.next=15;break;case 14:e.t0=e.sent;case 15:if(!e.t0){e.next=19;break}User.updateOne({_id:i.id},{login:!0}).then(function(){t.status(201).json({_id:i.id,username:i.username,email:i.email,login:!0,token:generateToken(i._id)})}).catch(function(e){t.status(400).json({status:"FAILED",message:"An error occur while updating login data update"})}),e.next=20;break;case 19:t.status(400).json({status:"FAILED",message:"Email, Password is something wrong"});case 20:case"end":return e.stop()}})}),generateToken=function(e){return jwt.sign({id:e},"".concat(process.env.JWT_SECRET),{expiresIn:"30d"})},updateUser=asyncHandler(function(r,t){var s,n,a,i,o,u,c,l,d,f,p;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return s=r.body,n=s.username,a=s.email,i=s.address,o=s.gender,u=r.file,c=r.user.id,e.next=5,regeneratorRuntime.awrap(User.findById(c));case 5:if(l=e.sent,r.user){e.next=9;break}throw t.status(404),new Error("user not found");case 9:return d=[],void 0!==u&&u!==[]&&(f={fileName:u.filename,filePath:u.path,fileType:u.mimetype,fileSize:fileSizeFormatter(u.size,2)},d.push(f)),u!==[]&&void 0!==u||""===l.profilePicture[0]?""===l.profilePicture[0]||0===l.profilePicture.length?console.log("new user is updated without new profile image"):l.profilePicture.map(function(r){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",fs.unlink(path.join(mainPath,r.filePath),function(e){return e&&console.log("error occur",e),console.log("file is deleted successully")}));case 1:case"end":return e.stop()}})}):l.profilePicture.forEach(function(e){var r={fileName:e.fileName,filePath:e.filePath,fileType:e.fileType,fileSize:e.fileSize};d.push(r)}),e.next=14,regeneratorRuntime.awrap(User.updateOne({_id:c},{$set:{username:n,email:a,login:!0,gender:o,address:i,profilePicture:d||[]}}));case 14:return e.next=16,regeneratorRuntime.awrap(User.findById(c));case 16:p=e.sent,t.status(200).json({_id:c,username:p.username,email:p.email,address:p.address,gender:p.gender,profilePicture:p.profilePicture,login:p.login});case 18:case"end":return e.stop()}})}),fileSizeFormatter=function(e,r){if(0===e)return"0 byte";var t=r||2,s=Math.floor(Math.log(e)/Math.log(1e3));return parseFloat((e/Math.pow(1e3,s)).toFixed(t))+"-"+["Bytes","KB","MB","GB","TB","PB","EB","YB","ZB"][s]},deleteUserAccount=function(r,t){var s,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return s=r.user.id,e.next=3,regeneratorRuntime.awrap(User.findById(s));case 3:if(n=e.sent,r.user){e.next=7;break}throw t.status(401),new Error("user not found");case 7:return n.profilePicture===[]||""===n.profilePicture[0]||0===n.profilePicture.length?console.log("file is empty file"):n.profilePicture.map(function(r){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",fs.unlink(path.join(mainPath,r.filePath),function(e){return e&&console.log("error occur",e),console.log("file is deleted successully")}));case 1:case"end":return e.stop()}})}),e.next=10,regeneratorRuntime.awrap(User.findByIdAndRemove(s).exec());case 10:t.status(200).json("User Account Deleted Successfully");case 11:case"end":return e.stop()}})};module.exports={getAllUser:getAllUser,registerUser:registerUser,loginUser:loginUser,updateUser:updateUser,deleteUserAccount:deleteUserAccount};
//# sourceMappingURL=userController.min.js.map
