"use strict";var jwt=require("jsonwebtoken"),fs=require("fs"),asyncHandler=require("express-async-handler"),mainPath=require("./baseFilepath"),User=require("../model/userModel"),bcrypt=require("bcryptjs"),path=require("path"),getAllUser=function(e,r){r.render("user/register",{pageTitle:"Register",path:"/register"})},registerUser=asyncHandler(function(r,t){var s,n,a,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=r.body,n=s.username,a=s.email,u=s.password,n=n.trim(),a=a.trim(),u=u.trim(),n&&a&&u){e.next=6;break}return e.abrupt("return",t.status(404).json({status:"FAILED",message:"Empty input Fields!"}));case 6:if(/^[a-zA-Z ]*$/.test(n)){e.next=8;break}return e.abrupt("return",t.status(400).json({status:"FAILED",message:"Invalid name entered"}));case 8:if(/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/.test(a)){e.next=10;break}return e.abrupt("return",t.status(400).json({status:"FAILED",message:"Invalid email entered"}));case 10:if(u.length<8)return e.abrupt("return",t.status(400).json({status:"FAILED",message:"Password is too short!"}));e.next=12;break;case 12:return e.next=14,regeneratorRuntime.awrap(User.find({email:a}).then(function(e){if(e.length)return t.status(400).json({status:"FAILED",message:"User with the provided email already exists"});bcrypt.hash(u,10).then(function(e){new User({username:n,email:a,password:e}).save().then(function(e){console.log("user  post is success"),t.status(201).json(e)}).catch(function(e){t.status(400).json({status:"FAILED",message:"An error occurred while saving user account!"})})}).catch(function(e){t.status(400).json({status:"FAILED",message:"An error occurred while hashing password!"})})}).catch(function(e){t.status(400).json({status:"FAILED",message:"An error occured while checking for existing user!"})}));case 14:case"end":return e.stop()}})}),loginUser=asyncHandler(function(r,t){var s,n,a,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=r.body,n=s.email,a=s.password,n=n.trim(),a=a.trim(),""==n||""==a)return e.abrupt("return",t.status(400).json({status:"FAILED",message:"Empty credentials supplied"}));e.next=5;break;case 5:return e.next=7,regeneratorRuntime.awrap(User.findOne({email:n}));case 7:if(u=e.sent,e.t0=u,e.t0)return e.next=12,regeneratorRuntime.awrap(bcrypt.compare(a,u.password));e.next=13;break;case 12:e.t0=e.sent;case 13:if(!e.t0){e.next=17;break}User.updateOne({_id:u.id},{login:!0}).then(function(){t.status(201).json({_id:u.id,username:u.username,email:u.email,login:!0,token:generateToken(u._id)})}).catch(function(e){t.status(400).json({status:"FAILED",message:"An error occur while updating login data update"})}),e.next=18;break;case 17:t.status(400).json({status:"FAILED",message:"Email, Password is something wrong"});case 18:case"end":return e.stop()}})}),generateToken=function(e){return jwt.sign({id:e},"".concat(process.env.JWT_SECRET),{expiresIn:"30d"})},updateUser=asyncHandler(function(r,t){var s,n,a,u,i,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=r.body,n=s.username,a=s.address,u=s.gender,i=r.user.id,r.user){e.next=4;break}return e.abrupt("return",t.status(404).json({status:"FAILED",message:"user not found"}));case 4:return e.next=6,regeneratorRuntime.awrap(User.updateOne({_id:i},{$set:{username:n,login:!0,gender:u,address:a}}));case 6:return e.next=8,regeneratorRuntime.awrap(User.findById(i));case 8:o=e.sent,t.status(200).json({_id:i,username:o.username,email:o.email,address:o.address,gender:o.gender,profilePicture:o.profilePicture,login:o.login});case 10:case"end":return e.stop()}})}),updateUserProfile=asyncHandler(function(r,t){var s,n,a,u,i,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return s=r.file,n=r.user.id,e.next=4,regeneratorRuntime.awrap(User.findById(n));case 4:if(a=e.sent,r.user){e.next=7;break}return e.abrupt("return",t.status(404).json({status:"FAILED",message:"user not found"}));case 7:if(u=[],void 0!==s&&s!==[])return i={fileName:s.filename,filePath:s.path,fileType:s.mimetype,fileSize:fileSizeFormatter(s.size,2)},u.push(i),""!==a.profilePicture[0]&&fs.unlink(path.join(mainPath,a.profilePicture[0].filePath),function(e){if(e)return console.log("error occur",e);console.log("file is deleted successully")}),e.next=14,regeneratorRuntime.awrap(User.updateOne({_id:n},{$set:{profilePicture:u}}));e.next=14;break;case 14:return e.next=16,regeneratorRuntime.awrap(User.findById(n));case 16:o=e.sent,t.status(200).json({_id:n,username:o.username,email:o.email,address:o.address,gender:o.gender,profilePicture:o.profilePicture,login:o.login});case 18:case"end":return e.stop()}})}),fileSizeFormatter=function(e,r){if(0===e)return"0 byte";var t=r||2,s=Math.floor(Math.log(e)/Math.log(1e3));return parseFloat((e/Math.pow(1e3,s)).toFixed(t))+"-"+["Bytes","KB","MB","GB","TB","PB","EB","YB","ZB"][s]},deleteUserAccount=function(r,t){var s,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return s=r.user.id,e.next=3,regeneratorRuntime.awrap(User.findById(s));case 3:if(n=e.sent,r.user){e.next=6;break}return e.abrupt("return",t.status(404).json({status:"FAILED",message:"user not found"}));case 6:return""===n.profilePicture[0]||0===n.profilePicture.length?console.log("file is empty file"):fs.unlink(path.join(mainPath,n.profilePicture[0].filePath),function(e){if(e)return console.log("error occur",e);console.log("file is deleted successully")}),e.next=9,regeneratorRuntime.awrap(User.findByIdAndRemove(s).exec());case 9:t.status(200).json("User Account Deleted Successfully");case 10:case"end":return e.stop()}})},getAlluser=function(e,r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(User.find());case 3:t=e.sent,r.status(200).send(t),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),r.status(400).send(e.t0.message);case 10:case"end":return e.stop()}},null,null,[[0,7]])},getUserDetail=asyncHandler(function(r,t){var s,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return s=r.params.id,e.prev=1,e.next=4,regeneratorRuntime.awrap(User.findById(s));case 4:n=e.sent,t.status(200).send(n),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(1),t.status(400).send(e.t0.message);case 11:case"end":return e.stop()}},null,null,[[1,8]])});module.exports={getAllUser:getAllUser,registerUser:registerUser,loginUser:loginUser,updateUser:updateUser,updateUserProfile:updateUserProfile,deleteUserAccount:deleteUserAccount,getAlluser:getAlluser,getUserDetail:getUserDetail};
//# sourceMappingURL=userController.min.js.map
